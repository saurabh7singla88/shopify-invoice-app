{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Shopify Invoice App - CloudFormation Template (JSON format)",
  "Parameters": {
    "AppName": {
      "Type": "String",
      "Default": "shopify-invoice-app",
      "Description": "Name of the application"
    },
    "Environment": {
      "Type": "String",
      "Default": "production",
      "AllowedValues": ["development", "staging", "production"],
      "Description": "Environment name"
    },
    "ShopifyApiKey": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Shopify API Key"
    },
    "ShopifyApiSecret": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Shopify API Secret"
    },
    "ShopifyAppUrl": {
      "Type": "String",
      "Description": "Shopify App URL - leave empty to use generated API Gateway URL"
    },
    "DynamoDBSessionTable": {
      "Type": "String",
      "Default": "shopify_sessions",
      "Description": "DynamoDB table name for session storage"
    },
    "Scopes": {
      "Type": "String",
      "Default": "read_orders,write_orders",
      "Description": "Comma-separated list of Shopify API scopes"
    }
  },
  "Resources": {
    "AssetsBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${AppName}-assets-${AWS::AccountId}"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": false,
          "BlockPublicPolicy": false,
          "IgnorePublicAcls": false,
          "RestrictPublicBuckets": false
        },
        "CorsConfiguration": {
          "CorsRules": [
            {
              "AllowedHeaders": ["*"],
              "AllowedMethods": ["GET", "HEAD"],
              "AllowedOrigins": ["*"],
              "MaxAge": 3600
            }
          ]
        }
      }
    },
    "AssetsBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "AssetsBucket" },
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": {
                "Fn::Sub": "${AssetsBucket.Arn}/*"
              }
            }
          ]
        }
      }
    },
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "${AppName}-lambda-role"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "DynamoDBAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:GetItem",
                    "dynamodb:PutItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:DeleteItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoDBSessionTable}"
                    },
                    {
                      "Fn::Sub": "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoDBSessionTable}/index/*"
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "S3Access",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["s3:GetObject", "s3:PutObject"],
                  "Resource": [
                    {
                      "Fn::Sub": "${AssetsBucket.Arn}/*"
                    }
                  ]
                }
              ]
            }
          }
        ]
      }
    },
    "ShopifyAppFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": { "Ref": "AppName" },
        "Runtime": "nodejs20.x",
        "Handler": "server.lambdaHandler",
        "Code": {
          "ZipFile": "exports.lambdaHandler = async () => ({ statusCode: 200, body: 'Placeholder - Deploy your code' });"
        },
        "MemorySize": 1024,
        "Timeout": 30,
        "Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"] },
        "Environment": {
          "Variables": {
            "NODE_ENV": { "Ref": "Environment" },
            "SHOPIFY_API_KEY": { "Ref": "ShopifyApiKey" },
            "SHOPIFY_API_SECRET": { "Ref": "ShopifyApiSecret" },
            "SHOPIFY_APP_URL": { "Ref": "ShopifyAppUrl" },
            "SCOPES": { "Ref": "Scopes" },
            "DYNAMODB_SESSION_TABLE": { "Ref": "DynamoDBSessionTable" }
          }
        }
      }
    },
    "HttpApi": {
      "Type": "AWS::ApiGatewayV2::Api",
      "Properties": {
        "Name": {
          "Fn::Sub": "${AppName}-api"
        },
        "ProtocolType": "HTTP",
        "CorsConfiguration": {
          "AllowOrigins": ["*"],
          "AllowHeaders": ["*"],
          "AllowMethods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
          "MaxAge": 600
        }
      }
    },
    "HttpApiIntegration": {
      "Type": "AWS::ApiGatewayV2::Integration",
      "Properties": {
        "ApiId": { "Ref": "HttpApi" },
        "IntegrationType": "AWS_PROXY",
        "IntegrationUri": {
          "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ShopifyAppFunction.Arn}/invocations"
        },
        "PayloadFormatVersion": "2.0",
        "TimeoutInMillis": 30000
      }
    },
    "HttpApiRoute": {
      "Type": "AWS::ApiGatewayV2::Route",
      "Properties": {
        "ApiId": { "Ref": "HttpApi" },
        "RouteKey": "$default",
        "Target": {
          "Fn::Sub": "integrations/${HttpApiIntegration}"
        }
      }
    },
    "HttpApiStage": {
      "Type": "AWS::ApiGatewayV2::Stage",
      "Properties": {
        "ApiId": { "Ref": "HttpApi" },
        "StageName": "$default",
        "AutoDeploy": true
      }
    },
    "LambdaApiPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "ShopifyAppFunction" },
        "Action": "lambda:InvokeFunction",
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${HttpApi}/*/*"
        }
      }
    }
  },
  "Outputs": {
    "ApiGatewayUrl": {
      "Description": "API Gateway endpoint URL - Use this as your SHOPIFY_APP_URL",
      "Value": {
        "Fn::Sub": "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"
      }
    },
    "AssetsBucketName": {
      "Description": "S3 bucket name for static assets",
      "Value": { "Ref": "AssetsBucket" }
    },
    "SessionTableName": {
      "Description": "DynamoDB table name for sessions (using existing table)",
      "Value": { "Ref": "DynamoDBSessionTable" }
    },
    "LambdaFunctionName": {
      "Description": "Lambda Function Name",
      "Value": { "Ref": "ShopifyAppFunction" }
    },
    "LambdaFunctionArn": {
      "Description": "Lambda Function ARN",
      "Value": { "Fn::GetAtt": ["ShopifyAppFunction", "Arn"] }
    }
  }
}
